# Auto-Approve Dependabot PRs (POL-014: Automated Dependency Updates)
# Automatically approves Dependabot pull requests after all checks pass
# Also keeps Dependabot PRs up-to-date with base branch changes
#
# Security Features:
# - Only runs for dependabot[bot] PRs (strict author check)
# - Requires all CI checks to pass before approval
# - Uses workflow_run trigger to wait for PR Verification to complete
# - Minimal permissions (pull-requests: write, contents: write for rebase)
#
# Workflow:
# 1. PR opened/updated by Dependabot
# 2. Update PR branch when main branch changes (auto-rebase)
# 3. All CI checks run (verify.yml, security-scan.yml)
# 4. When PR Verification completes successfully ‚Üí auto-approve and auto-merge
# 5. No manual intervention required
#
# Reference: POL-014 (Automated Dependency Updates)
# Reference: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run

name: Auto-Approve Dependabot

on:
  # Trigger when PR Verification workflow completes
  workflow_run:
    workflows: ['PR Verification']
    types: [completed]
  # Also trigger when main branch is pushed (to update open Dependabot PRs)
  push:
    branches:
      - main

# Minimal permissions for security (principle of least privilege)
permissions:
  pull-requests: write
  contents: write # Needed for rebasing PR branches

jobs:
  # Keep Dependabot PRs up-to-date with base branch
  update-dependabot-prs:
    name: Update Dependabot PRs with Base Branch
    runs-on: ubuntu-latest
    # Only run on push to main (to update open Dependabot PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Update Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open PRs from Dependabot
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const dependabotPRs = pullRequests.filter(pr =>
              pr.user.login === 'dependabot[bot]'
            );

            console.log(`Found ${dependabotPRs.length} open Dependabot PRs`);

            // Update each Dependabot PR with latest main
            for (const pr of dependabotPRs) {
              try {
                await github.rest.pulls.updateBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number
                });
                console.log(`‚úÖ Updated PR #${pr.number}: ${pr.title}`);
              } catch (error) {
                const msg = error.message;
                console.log(`‚ö†Ô∏è Could not update PR #${pr.number}: ${msg}`);
              }
            }

  # Wait for all required checks to complete and auto-approve
  dependabot-approve:
    name: Auto-Approve Dependabot PR
    runs-on: ubuntu-latest
    # Only run when workflow_run event completes successfully
    # Security: prevent unauthorized approvals
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Get PR Number and Verify Dependabot
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the pull requests associated with this workflow run
            const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.workflow_run.head_sha
            });

            // Filter for open PRs
            const openPRs = pullRequests.filter(pr => pr.state === 'open');

            if (openPRs.length === 0) {
              console.log('No open PRs found for this commit');
              return;
            }

            const pr = openPRs[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);
            console.log(`PR author: ${pr.user.login}`);

            // Verify this is a Dependabot PR
            if (pr.user.login !== 'dependabot[bot]') {
              console.log('Not a Dependabot PR, skipping approval');
              return;
            }

            console.log('‚úÖ Verified Dependabot PR');
            core.setOutput('pr_number', pr.number);
            core.setOutput('is_dependabot', 'true');

      - name: Approve PR
        if: steps.pr.outputs.is_dependabot == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.pr.outputs.pr_number }}

      - name: Auto-Merge PR
        if: steps.pr.outputs.is_dependabot == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};

            try {
              // Enable auto-merge with squash method
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log(`‚úÖ Successfully merged PR #${prNumber}`);
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not merge PR #${prNumber}: ${error.message}`);
              throw error;
            }

      - name: Add Success Comment
        if: steps.pr.outputs.is_dependabot == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};

            const body = [
              '‚úÖ **Auto-approved and merged by Dependabot workflow**',
              '',
              'All CI checks passed successfully.',
              'This PR has been automatically approved and merged.',
              '',
              'üéâ Changes are now in the main branch.'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
