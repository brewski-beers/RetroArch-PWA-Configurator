# Auto-Approve Dependabot PRs (POL-014: Automated Dependency Updates)
# Automatically approves Dependabot pull requests after all checks pass
# Also keeps Dependabot PRs up-to-date with base branch changes
#
# Security Features:
# - Only runs for dependabot[bot] PRs (strict author check)
# - Requires all CI checks to pass before approval
# - Uses pull_request_target for proper GITHUB_TOKEN permissions
# - Minimal permissions (pull-requests: write, contents: write for rebase)
#
# Workflow:
# 1. PR opened/updated by Dependabot
# 2. Update PR branch when main branch changes (auto-rebase)
# 3. All CI checks run (verify.yml, security-scan.yml)
# 4. If all checks pass ‚Üí auto-approve
# 5. Manual merge still required (auto-merge can be added later)
#
# Reference: POL-014 (Automated Dependency Updates)
# Reference: https://docs.github.com/en/code-security/dependabot

name: Auto-Approve Dependabot

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  # Also trigger when main branch is pushed (to update open Dependabot PRs)
  push:
    branches:
      - main

# Minimal permissions for security (principle of least privilege)
permissions:
  pull-requests: write
  contents: write  # Needed for rebasing PR branches

jobs:
  # Keep Dependabot PRs up-to-date with base branch
  update-dependabot-prs:
    name: Update Dependabot PRs with Base Branch
    runs-on: ubuntu-latest
    # Only run on push to main (to update open Dependabot PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Update Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open PRs from Dependabot
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const dependabotPRs = pullRequests.filter(pr =>
              pr.user.login === 'dependabot[bot]'
            );

            console.log(`Found ${dependabotPRs.length} open Dependabot PRs`);

            // Update each Dependabot PR with latest main
            for (const pr of dependabotPRs) {
              try {
                await github.rest.pulls.updateBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number
                });
                console.log(`‚úÖ Updated PR #${pr.number}: ${pr.title}`);
              } catch (error) {
                const msg = error.message;
                console.log(`‚ö†Ô∏è Could not update PR #${pr.number}: ${msg}`);
              }
            }

  # Wait for all required checks to complete and auto-approve
  dependabot-approve:
    name: Auto-Approve Dependabot PR
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs on pull_request_target events
    # Security: prevent unauthorized approvals
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Wait for CI Checks
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          # Wait for the main verification workflow
          check-name: '‚úÖ Ready to Merge'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 20
          allowed-conclusions: success

      - name: Approve PR
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Success Comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '‚úÖ **Auto-approved by Dependabot workflow**',
              '',
              'All CI checks passed successfully.',
              'This PR has been automatically approved.',
              '',
              'üí° **Note**: Manual merge is still required.',
              'Review the changes and merge when ready.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
