name: PR Verification

on:
  pull_request:
    branches: [main, master]
    # Note: Path filters removed to ensure this workflow ALWAYS runs for ALL PRs
    # This is required for branch protection, especially for Dependabot PRs
    # that may only update files like package.json or .github/workflows/*.yml

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Fast-fail checks (run first, fail fast)
  format-and-lint:
    name: Format & Lint (Fast Fail)
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-node-env

      - name: Check Prettier Formatting
        run: npm run format:check

      - name: Check ESLint
        run: npm run lint

  # Fast parallel checks
  type-check-and-build:
    name: Type Check & Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: format-and-lint

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-node-env

      - name: Build TypeScript
        uses: ./.github/actions/build-typescript
        with:
          upload-artifacts: 'true'

  # Unit tests - independent, can run in parallel
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: type-check-and-build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-node-env

      - name: Run Unit Tests
        uses: ./.github/actions/run-tests
        with:
          test-type: 'unit'

  # Policy check - depends on build
  policy-check:
    name: Policy Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: type-check-and-build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-node-env
        with:
          install-dependencies: 'true'

      - name: Run Policy Check
        uses: ./.github/actions/run-tests
        with:
          test-type: 'policy'
          download-build: 'true'

  # E2E tests - depends on build
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: type-check-and-build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-node-env

      - name: Install Playwright
        uses: ./.github/actions/install-playwright
        with:
          browser: 'chromium'

      - name: Run E2E Tests
        uses: ./.github/actions/run-tests
        with:
          test-type: 'e2e'
          download-build: 'true'

  # Status check for branch protection
  all-checks-passed:
    name: ✅ Ready to Merge
    runs-on: ubuntu-latest
    needs:
      [
        format-and-lint,
        type-check-and-build,
        unit-tests,
        policy-check,
        e2e-tests,
      ]
    if: always()

    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.format-and-lint.result }}" != "success" ] || \
             [ "${{ needs.type-check-and-build.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.policy-check.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed - ready to merge!"
