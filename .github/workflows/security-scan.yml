# Security Scanning Workflow (POL-016, POL-017)
# Streamlined security checks leveraging GitHub native features
#
# GitHub Native Features (enabled in repo settings):
# - Dependabot security alerts (POL-011, POL-014)
# - Dependency Review Action (blocks vulnerable PRs)
# - CodeQL (SAST scanning)
# - Secret scanning
#
# Custom Checks:
# - POL-016: License Compliance (MIT-compatible only)
# - POL-017: Supply Chain Security (lockfile integrity)
#
# Runs on:
# - Pull requests to main
# - Push to main (post-merge validation)
# - Weekly scheduled scan (Sundays at 2 AM)

name: Security Scan

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    # Weekly scan on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Manual trigger

# Prevent duplicate runs for PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # GitHub Native: Dependency Review (replaces npm-audit for PRs)
  # Automatically blocks PRs with vulnerable dependencies
  dependency-review:
    name: Dependency Review (GitHub Native)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  # POL-016: License Compliance (custom check)
  license-compliance:
    name: License Compliance (POL-016)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "## ðŸ“‹ License Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for forbidden licenses
          FORBIDDEN=$(license-checker --onlyunknown --exclude "MIT,Apache-2.0,BSD,BSD-2-Clause,BSD-3-Clause,ISC,0BSD,CC0-1.0,Unlicense,WTFPL" 2>&1 || true)
          
          if [ -n "$FORBIDDEN" ]; then
            echo "âš ï¸ **Potential license issues detected:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$FORBIDDEN" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All dependencies use OSI-approved licenses" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          license-checker --summary >> $GITHUB_STEP_SUMMARY || true

  # POL-017: Supply Chain Security (custom check)
  supply-chain-security:
    name: Supply Chain Security (POL-017)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify package-lock.json integrity
        run: |
          echo "## ðŸ”’ Supply Chain Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ package-lock.json not found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify lockfile version (should be v2 or v3)
          LOCKFILE_VERSION=$(jq -r '.lockfileVersion' package-lock.json)
          
          # Use arithmetic expansion for safer numeric comparison
          if (( LOCKFILE_VERSION < 2 )); then
            echo "âŒ package-lock.json uses old format (v$LOCKFILE_VERSION)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Lockfile integrity verified (v$LOCKFILE_VERSION)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Verify lockfile consistency
        run: |
          npm ci --dry-run --ignore-scripts
          echo "âœ… Lockfile is consistent with package.json" >> $GITHUB_STEP_SUMMARY

  # Summary Report
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [license-compliance, supply-chain-security]
    # Run even if dependency-review is skipped (not a PR)
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub Native Features (Enabled):**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Dependabot: Automated security updates" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Dependency Review: Blocks vulnerable PRs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ CodeQL: SAST code scanning" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Secret Scanning: Prevents credential leaks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Custom Policy Checks:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… POL-016: License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… POL-017: Supply Chain Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** Dependabot PRs auto-created weekly for updates" >> $GITHUB_STEP_SUMMARY

